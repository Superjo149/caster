"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _requestResponse = _interopRequireDefault(require("./request-response"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class MediaController extends _requestResponse.default {
  constructor(client, sourceId, destinationId) {
    super(client, sourceId, destinationId, 'urn:x-cast:com.google.cast.media');
    this.currentSession = void 0;
    this.currentSession = null;
    const self = this;

    function onMessage(data, broadcast) {
      if (data.type === 'MEDIA_STATUS' && broadcast) {
        const status = data.status[0];
        if (!status) return;
        self.currentSession = status;
        self.emit('status', status);
      }
    }

    function onClose() {
      self.removeListener('message', onMessage);
      self.stop();
    }

    this.on('message', onMessage);
    this.once('close', onClose);
  }
  /**
   * Get the status
   * @returns a promise containing the status
   */


  getStatus() {
    return this.request({
      type: 'GET_STATUS'
    }).then(response => {
      const status = response.status[0];
      this.currentSession = status;
      return status;
    });
  }
  /**
   * Load media
   * @param {Object} media
   * @param {Object} [options = {}]
   * @returns {Promise}
   */


  load(media, options = {}) {
    return new Promise((resolve, reject) => {
      const data = Object.assign({
        type: 'LOAD',
        media,
        autoplay: false,
        currentTime: 0,
        activeTrackIds: [],
        repeatMode: 'REPEAT_OFF'
      }, options);
      this.request(data).then(response => {
        if (response.type === 'LOAD_FAILED') return reject(new Error('Load failed'));
        if (response.type === 'LOAD_CANCELLED') return reject(new Error('Load cancelled'));
        const status = response.status[0];
        return resolve(status);
      }).catch(err => reject(err));
    });
  }
  /**
   * Session request
   * @param {Object} data
   * @returns {Promise}
   */


  sessionRequest(data) {
    return new Promise((resolve, reject) => {
      data.mediaSessionId = this.currentSession.mediaSessionId;
      this.request(data).then(response => {
        const status = response.status[0];
        return resolve(status);
      }).catch(err => reject(err));
    });
  }
  /**
   * Play the media
   * @returns {Promise}
   */


  play() {
    return new Promise((resolve, reject) => {
      this.sessionRequest({
        type: 'PLAY'
      }).then(response => resolve(response)).catch(err => reject(err));
    });
  }
  /**
   * Pause the media
   * @returns {Promise}
   */


  pause() {
    return new Promise((resolve, reject) => {
      this.sessionRequest({
        type: 'PAUSE'
      }).then(response => resolve(response)).catch(err => reject(err));
    });
  }
  /**
   * Stop the media
   * @returns {Promise}
   */


  stop() {
    return new Promise((resolve, reject) => {
      this.sessionRequest({
        type: 'STOP'
      }).then(response => resolve(response)).catch(err => reject(err));
    });
  }
  /**
   * Seek through the media
   * @param {Number} currentTime - Time to seek to
   * @returns {Promise}
   */


  seek(currentTime) {
    return new Promise((resolve, reject) => {
      this.sessionRequest({
        type: 'SEEK',
        currentTime
      }).then(response => resolve(response)).catch(err => reject(err));
    });
  }
  /**
   * Load a queue of items to play (playlist)
   * @see https://developers.google.com/cast/docs/reference/chrome/chrome.cast.media.QueueLoadRequest
   * @param {Object[]} items - Items to load into the queue
   * @param {Object} options - Options
   * @returns {Promise}
   */


  queueLoad(items, options = {}) {
    return new Promise((resolve, reject) => {
      const data = Object.assign({}, {
        type: 'QUEUE_LOAD',
        repeatMode: 'REPEAT_OFF',
        startIndex: 0,
        items
      }, options);
      this.request(data).then(response => {
        if (response.type === 'LOAD_FAILED') return reject(new Error('queueLoad failed'));
        if (response.type === 'LOAD_CANCELLED') return reject(new Error('queueLoad cancelled'));
        const status = response.status[0];
        return resolve(status);
      }).catch(console.log);
    });
  }
  /**
   * Insert items into the queue
   * @param {Object[]} items - Items to insert
   * @param {Object} options - Options
   * @returns {Promise}
   */


  queueInsert(items, options) {
    return new Promise((resolve, reject) => {
      const data = Object.assign({
        type: 'QUEUE_INSERT',
        items
      }, options);
      this.sessionRequest(data).then(response => resolve(response)).catch(err => reject(err));
    });
  }
  /**
   * Remove items from the queue
   * @param {String[]} itemIds - IDs to remove
   * @param {Object} options - Options
   * @returns {Promise}
   */


  queueRemove(itemIds, options) {
    return new Promise((resolve, reject) => {
      const data = Object.assign({
        type: 'QUEUE_REMOVE',
        itemIds
      }, options);
      this.sessionRequest(data).then(response => resolve(response)).catch(err => reject(err));
    });
  }
  /**
   * Reorder the queue
   * @param {String[]} itemIds - IDs to reorder
   * @param {Object} options - Options
   * @returns {Promise}
   */


  queueReorder(itemIds, options) {
    return new Promise((resolve, reject) => {
      const data = Object.assign({
        type: 'QUEUE_REORDER',
        itemIds
      }, options);
      this.sessionRequest(data).then(response => resolve(response)).catch(err => reject(err));
    });
  }
  /**
   * Update the queue
   * @param {Object[]} items - Items
   * @param {Object} options - Options
   * @returns {Promise}
   */


  queueUpdate(items, options) {
    return new Promise((resolve, reject) => {
      const data = Object.assign({
        type: 'QUEUE_UPDATE',
        items
      }, options);
      this.sessionRequest(data).then(response => resolve(response)).catch(err => reject(err));
    });
  }

}

exports.default = MediaController;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb250cm9sbGVycy9tZWRpYS50cyJdLCJuYW1lcyI6WyJNZWRpYUNvbnRyb2xsZXIiLCJSZXF1ZXN0UmVzcG9uc2VDb250cm9sbGVyIiwiY29uc3RydWN0b3IiLCJjbGllbnQiLCJzb3VyY2VJZCIsImRlc3RpbmF0aW9uSWQiLCJjdXJyZW50U2Vzc2lvbiIsInNlbGYiLCJvbk1lc3NhZ2UiLCJkYXRhIiwiYnJvYWRjYXN0IiwidHlwZSIsInN0YXR1cyIsImVtaXQiLCJvbkNsb3NlIiwicmVtb3ZlTGlzdGVuZXIiLCJzdG9wIiwib24iLCJvbmNlIiwiZ2V0U3RhdHVzIiwicmVxdWVzdCIsInRoZW4iLCJyZXNwb25zZSIsImxvYWQiLCJtZWRpYSIsIm9wdGlvbnMiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsIk9iamVjdCIsImFzc2lnbiIsImF1dG9wbGF5IiwiY3VycmVudFRpbWUiLCJhY3RpdmVUcmFja0lkcyIsInJlcGVhdE1vZGUiLCJFcnJvciIsImNhdGNoIiwiZXJyIiwic2Vzc2lvblJlcXVlc3QiLCJtZWRpYVNlc3Npb25JZCIsInBsYXkiLCJwYXVzZSIsInNlZWsiLCJxdWV1ZUxvYWQiLCJpdGVtcyIsInN0YXJ0SW5kZXgiLCJjb25zb2xlIiwibG9nIiwicXVldWVJbnNlcnQiLCJxdWV1ZVJlbW92ZSIsIml0ZW1JZHMiLCJxdWV1ZVJlb3JkZXIiLCJxdWV1ZVVwZGF0ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUNBOzs7O0FBRWUsTUFBTUEsZUFBTixTQUE4QkMsd0JBQTlCLENBQXdEO0FBR3JFQyxFQUFBQSxXQUFXLENBQUNDLE1BQUQsRUFBaUJDLFFBQWpCLEVBQW1DQyxhQUFuQyxFQUEwRDtBQUNuRSxVQUFNRixNQUFOLEVBQWNDLFFBQWQsRUFBd0JDLGFBQXhCLEVBQXVDLGtDQUF2QztBQURtRSxTQUY3REMsY0FFNkQ7QUFFbkUsU0FBS0EsY0FBTCxHQUFzQixJQUF0QjtBQUNBLFVBQU1DLElBQUksR0FBRyxJQUFi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Q0FBWSxDQUFDQyxPQUFELEVBQVVDLE1BQVYsS0FBcUI7QUFDdEMsWUFBTW5CLElBQUksR0FBR29CLE1BQU0sQ0FBQ0MsTUFBUCxDQUNYO0FBQ0VuQixRQUFBQSxJQUFJLEVBQUUsZUFEUjtBQUVFdUMsUUFBQUE7QUFGRixPQURXLEVBS1h6QixPQUxXLENBQWI7QUFPQSxXQUFLYSxjQUFMLENBQW9CN0IsSUFBcEIsRUFDR1ksSUFESCxDQUNRQyxRQUFRLElBQUlLLE9BQU8sQ0FBQ0wsUUFBRCxDQUQzQixFQUVHYyxLQUZILENBRVNDLEdBQUcsSUFBSVQsTUFBTSxDQUFDUyxHQUFELENBRnRCO0FBR0QsS0FYTSxDQUFQO0FBWUQ7QUFFRDs7Ozs7Ozs7QUFNQWUsRUFBQUEsV0FBVyxDQUFDUixLQUFELEVBQWtCbkIsT0FBbEIsRUFBbUM7QUFDNUMsV0FBTyxJQUFJQyxPQUFKLENBQVksQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEtBQXFCO0FBQ3RDLFlBQU1uQixJQUFJLEdBQUdvQixNQUFNLENBQUNDLE1BQVAsQ0FDWDtBQUNFbkIsUUFBQUEsSUFBSSxFQUFFLGNBRFI7QUFFRWlDLFFBQUFBO0FBRkYsT0FEVyxFQUtYbkIsT0FMVyxDQUFiO0FBT0EsV0FBS2EsY0FBTCxDQUFvQjdCLElBQXBCLEVBQ0dZLElBREgsQ0FDUUMsUUFBUSxJQUFJSyxPQUFPLENBQUNMLFFBQUQsQ0FEM0IsRUFFR2MsS0FGSCxDQUVTQyxHQUFHLElBQUlULE1BQU0sQ0FBQ1MsR0FBRCxDQUZ0QjtBQUdELEtBWE0sQ0FBUDtBQVlEOztBQXZRb0UiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDbGllbnQgfSBmcm9tICdjYXN0djInO1xuaW1wb3J0IFJlcXVlc3RSZXNwb25zZUNvbnRyb2xsZXIgZnJvbSAnLi9yZXF1ZXN0LXJlc3BvbnNlJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTWVkaWFDb250cm9sbGVyIGV4dGVuZHMgUmVxdWVzdFJlc3BvbnNlQ29udHJvbGxlciB7XG4gIHByaXZhdGUgY3VycmVudFNlc3Npb246IGFueTtcblxuICBjb25zdHJ1Y3RvcihjbGllbnQ6IENsaWVudCwgc291cmNlSWQ6IHN0cmluZywgZGVzdGluYXRpb25JZDogc3RyaW5nKSB7XG4gICAgc3VwZXIoY2xpZW50LCBzb3VyY2VJZCwgZGVzdGluYXRpb25JZCwgJ3Vybjp4LWNhc3Q6Y29tLmdvb2dsZS5jYXN0Lm1lZGlhJyk7XG4gICAgdGhpcy5jdXJyZW50U2Vzc2lvbiA9IG51bGw7XG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgZnVuY3Rpb24gb25NZXNzYWdlKGRhdGE6IGFueSwgYnJvYWRjYXN0OiBhbnkpIHtcbiAgICAgIGlmIChkYXRhLnR5cGUgPT09ICdNRURJQV9TVEFUVVMnICYmIGJyb2FkY2FzdCkge1xuICAgICAgICBjb25zdCBzdGF0dXMgPSBkYXRhLnN0YXR1c1swXTtcbiAgICAgICAgaWYgKCFzdGF0dXMpIHJldHVybjtcbiAgICAgICAgc2VsZi5jdXJyZW50U2Vzc2lvbiA9IHN0YXR1cztcbiAgICAgICAgc2VsZi5lbWl0KCdzdGF0dXMnLCBzdGF0dXMpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIG9uQ2xvc2UoKSB7XG4gICAgICBzZWxmLnJlbW92ZUxpc3RlbmVyKCdtZXNzYWdlJywgb25NZXNzYWdlKTtcbiAgICAgIHNlbGYuc3RvcCgpO1xuICAgIH1cbiAgICB0aGlzLm9uKCdtZXNzYWdlJywgb25NZXNzYWdlKTtcbiAgICB0aGlzLm9uY2UoJ2Nsb3NlJywgb25DbG9zZSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBzdGF0dXNcbiAgICogQHJldHVybnMgYSBwcm9taXNlIGNvbnRhaW5pbmcgdGhlIHN0YXR1c1xuICAgKi9cbiAgZ2V0U3RhdHVzKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRoaXNcbiAgICAgIC5yZXF1ZXN0KHtcbiAgICAgICAgdHlwZTogJ0dFVF9TVEFUVVMnXG4gICAgICB9KVxuICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgIGNvbnN0IHN0YXR1cyA9IHJlc3BvbnNlLnN0YXR1c1swXTtcbiAgICAgICAgdGhpcy5jdXJyZW50U2Vzc2lvbiA9IHN0YXR1cztcblxuICAgICAgICByZXR1cm4gc3RhdHVzO1xuICAgICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogTG9hZCBtZWRpYVxuICAgKiBAcGFyYW0ge09iamVjdH0gbWVkaWFcbiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zID0ge31dXG4gICAqIEByZXR1cm5zIHtQcm9taXNlfVxuICAgKi9cbiAgbG9hZChtZWRpYTogYW55LCBvcHRpb25zID0ge30pIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgZGF0YSA9IE9iamVjdC5hc3NpZ24oXG4gICAgICAgIHtcbiAgICAgICAgICB0eXBlOiAnTE9BRCcsXG4gICAgICAgICAgbWVkaWEsXG4gICAgICAgICAgYXV0b3BsYXk6IGZhbHNlLFxuICAgICAgICAgIGN1cnJlbnRUaW1lOiAwLFxuICAgICAgICAgIGFjdGl2ZVRyYWNrSWRzOiBbXSxcbiAgICAgICAgICByZXBlYXRNb2RlOiAnUkVQRUFUX09GRidcbiAgICAgICAgfSxcbiAgICAgICAgb3B0aW9uc1xuICAgICAgKTtcbiAgICAgIHRoaXMucmVxdWVzdChkYXRhKVxuICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3BvbnNlLnR5cGUgPT09ICdMT0FEX0ZBSUxFRCcpXG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0KG5ldyBFcnJvcignTG9hZCBmYWlsZWQnKSk7XG4gICAgICAgICAgaWYgKHJlc3BvbnNlLnR5cGUgPT09ICdMT0FEX0NBTkNFTExFRCcpXG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0KG5ldyBFcnJvcignTG9hZCBjYW5jZWxsZWQnKSk7XG4gICAgICAgICAgY29uc3Qgc3RhdHVzID0gcmVzcG9uc2Uuc3RhdHVzWzBdO1xuICAgICAgICAgIHJldHVybiByZXNvbHZlKHN0YXR1cyk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChlcnIgPT4gcmVqZWN0KGVycikpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFNlc3Npb24gcmVxdWVzdFxuICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YVxuICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICovXG4gIHNlc3Npb25SZXF1ZXN0KGRhdGE6IHsgdHlwZTogc3RyaW5nOyBba2V5OiBzdHJpbmddOiBhbnk7IH0pIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgZGF0YS5tZWRpYVNlc3Npb25JZCA9IHRoaXMuY3VycmVudFNlc3Npb24ubWVkaWFTZXNzaW9uSWQ7XG4gICAgICB0aGlzLnJlcXVlc3QoZGF0YSlcbiAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4ge1xuICAgICAgICAgIGNvbnN0IHN0YXR1cyA9IHJlc3BvbnNlLnN0YXR1c1swXTtcbiAgICAgICAgICByZXR1cm4gcmVzb2x2ZShzdGF0dXMpO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goZXJyID0+IHJlamVjdChlcnIpKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQbGF5IHRoZSBtZWRpYVxuICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICovXG4gIHBsYXkoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuc2Vzc2lvblJlcXVlc3Qoe1xuICAgICAgICB0eXBlOiAnUExBWSdcbiAgICAgIH0pXG4gICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHJlc29sdmUocmVzcG9uc2UpKVxuICAgICAgICAuY2F0Y2goZXJyID0+IHJlamVjdChlcnIpKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQYXVzZSB0aGUgbWVkaWFcbiAgICogQHJldHVybnMge1Byb21pc2V9XG4gICAqL1xuICBwYXVzZSgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5zZXNzaW9uUmVxdWVzdCh7XG4gICAgICAgIHR5cGU6ICdQQVVTRSdcbiAgICAgIH0pXG4gICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHJlc29sdmUocmVzcG9uc2UpKVxuICAgICAgICAuY2F0Y2goZXJyID0+IHJlamVjdChlcnIpKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdG9wIHRoZSBtZWRpYVxuICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICovXG4gIHN0b3AoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuc2Vzc2lvblJlcXVlc3Qoe1xuICAgICAgICB0eXBlOiAnU1RPUCdcbiAgICAgIH0pXG4gICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHJlc29sdmUocmVzcG9uc2UpKVxuICAgICAgICAuY2F0Y2goZXJyID0+IHJlamVjdChlcnIpKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZWVrIHRocm91Z2ggdGhlIG1lZGlhXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBjdXJyZW50VGltZSAtIFRpbWUgdG8gc2VlayB0b1xuICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICovXG4gIHNlZWsoY3VycmVudFRpbWU6IG51bWJlcikge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLnNlc3Npb25SZXF1ZXN0KHtcbiAgICAgICAgdHlwZTogJ1NFRUsnLFxuICAgICAgICBjdXJyZW50VGltZVxuICAgICAgfSlcbiAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gcmVzb2x2ZShyZXNwb25zZSkpXG4gICAgICAgIC5jYXRjaChlcnIgPT4gcmVqZWN0KGVycikpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIExvYWQgYSBxdWV1ZSBvZiBpdGVtcyB0byBwbGF5IChwbGF5bGlzdClcbiAgICogQHNlZSBodHRwczovL2RldmVsb3BlcnMuZ29vZ2xlLmNvbS9jYXN0L2RvY3MvcmVmZXJlbmNlL2Nocm9tZS9jaHJvbWUuY2FzdC5tZWRpYS5RdWV1ZUxvYWRSZXF1ZXN0XG4gICAqIEBwYXJhbSB7T2JqZWN0W119IGl0ZW1zIC0gSXRlbXMgdG8gbG9hZCBpbnRvIHRoZSBxdWV1ZVxuICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIE9wdGlvbnNcbiAgICogQHJldHVybnMge1Byb21pc2V9XG4gICAqL1xuICBxdWV1ZUxvYWQoaXRlbXM6IE9iamVjdFtdLCBvcHRpb25zOiBPYmplY3QgPSB7fSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCBkYXRhID0gT2JqZWN0LmFzc2lnbihcbiAgICAgICAge30sXG4gICAgICAgIHtcbiAgICAgICAgICB0eXBlOiAnUVVFVUVfTE9BRCcsXG4gICAgICAgICAgcmVwZWF0TW9kZTogJ1JFUEVBVF9PRkYnLFxuICAgICAgICAgIHN0YXJ0SW5kZXg6IDAsXG4gICAgICAgICAgaXRlbXNcbiAgICAgICAgfSxcbiAgICAgICAgb3B0aW9uc1xuICAgICAgKTtcblxuICAgICAgdGhpcy5yZXF1ZXN0KGRhdGEpXG4gICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICBpZiAocmVzcG9uc2UudHlwZSA9PT0gJ0xPQURfRkFJTEVEJylcbiAgICAgICAgICAgIHJldHVybiByZWplY3QobmV3IEVycm9yKCdxdWV1ZUxvYWQgZmFpbGVkJykpO1xuICAgICAgICAgIGlmIChyZXNwb25zZS50eXBlID09PSAnTE9BRF9DQU5DRUxMRUQnKVxuICAgICAgICAgICAgcmV0dXJuIHJlamVjdChuZXcgRXJyb3IoJ3F1ZXVlTG9hZCBjYW5jZWxsZWQnKSk7XG4gICAgICAgICAgY29uc3Qgc3RhdHVzID0gcmVzcG9uc2Uuc3RhdHVzWzBdO1xuICAgICAgICAgIHJldHVybiByZXNvbHZlKHN0YXR1cyk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChjb25zb2xlLmxvZyk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogSW5zZXJ0IGl0ZW1zIGludG8gdGhlIHF1ZXVlXG4gICAqIEBwYXJhbSB7T2JqZWN0W119IGl0ZW1zIC0gSXRlbXMgdG8gaW5zZXJ0XG4gICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gT3B0aW9uc1xuICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICovXG4gIHF1ZXVlSW5zZXJ0KGl0ZW1zOiBPYmplY3RbXSwgb3B0aW9uczogT2JqZWN0KSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGRhdGEgPSBPYmplY3QuYXNzaWduKFxuICAgICAgICB7XG4gICAgICAgICAgdHlwZTogJ1FVRVVFX0lOU0VSVCcsXG4gICAgICAgICAgaXRlbXNcbiAgICAgICAgfSxcbiAgICAgICAgb3B0aW9uc1xuICAgICAgKTtcbiAgICAgIHRoaXMuc2Vzc2lvblJlcXVlc3QoZGF0YSlcbiAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gcmVzb2x2ZShyZXNwb25zZSkpXG4gICAgICAgIC5jYXRjaChlcnIgPT4gcmVqZWN0KGVycikpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSBpdGVtcyBmcm9tIHRoZSBxdWV1ZVxuICAgKiBAcGFyYW0ge1N0cmluZ1tdfSBpdGVtSWRzIC0gSURzIHRvIHJlbW92ZVxuICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIE9wdGlvbnNcbiAgICogQHJldHVybnMge1Byb21pc2V9XG4gICAqL1xuICBxdWV1ZVJlbW92ZShpdGVtSWRzOiBzdHJpbmdbXSwgb3B0aW9uczogT2JqZWN0KSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGRhdGEgPSBPYmplY3QuYXNzaWduKFxuICAgICAgICB7XG4gICAgICAgICAgdHlwZTogJ1FVRVVFX1JFTU9WRScsXG4gICAgICAgICAgaXRlbUlkc1xuICAgICAgICB9LFxuICAgICAgICBvcHRpb25zXG4gICAgICApO1xuICAgICAgdGhpcy5zZXNzaW9uUmVxdWVzdChkYXRhKVxuICAgICAgICAudGhlbihyZXNwb25zZSA9PiByZXNvbHZlKHJlc3BvbnNlKSlcbiAgICAgICAgLmNhdGNoKGVyciA9PiByZWplY3QoZXJyKSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogUmVvcmRlciB0aGUgcXVldWVcbiAgICogQHBhcmFtIHtTdHJpbmdbXX0gaXRlbUlkcyAtIElEcyB0byByZW9yZGVyXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gT3B0aW9uc1xuICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICovXG4gIHF1ZXVlUmVvcmRlcihpdGVtSWRzOiBzdHJpbmdbXSwgb3B0aW9uczogT2JqZWN0KSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGRhdGEgPSBPYmplY3QuYXNzaWduKFxuICAgICAgICB7XG4gICAgICAgICAgdHlwZTogJ1FVRVVFX1JFT1JERVInLFxuICAgICAgICAgIGl0ZW1JZHNcbiAgICAgICAgfSxcbiAgICAgICAgb3B0aW9uc1xuICAgICAgKTtcbiAgICAgIHRoaXMuc2Vzc2lvblJlcXVlc3QoZGF0YSlcbiAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gcmVzb2x2ZShyZXNwb25zZSkpXG4gICAgICAgIC5jYXRjaChlcnIgPT4gcmVqZWN0KGVycikpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSB0aGUgcXVldWVcbiAgICogQHBhcmFtIHtPYmplY3RbXX0gaXRlbXMgLSBJdGVtc1xuICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIE9wdGlvbnNcbiAgICogQHJldHVybnMge1Byb21pc2V9XG4gICAqL1xuICBxdWV1ZVVwZGF0ZShpdGVtczogT2JqZWN0W10sIG9wdGlvbnM6IE9iamVjdCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCBkYXRhID0gT2JqZWN0LmFzc2lnbihcbiAgICAgICAge1xuICAgICAgICAgIHR5cGU6ICdRVUVVRV9VUERBVEUnLFxuICAgICAgICAgIGl0ZW1zXG4gICAgICAgIH0sXG4gICAgICAgIG9wdGlvbnNcbiAgICAgICk7XG4gICAgICB0aGlzLnNlc3Npb25SZXF1ZXN0KGRhdGEpXG4gICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHJlc29sdmUocmVzcG9uc2UpKVxuICAgICAgICAuY2F0Y2goZXJyID0+IHJlamVjdChlcnIpKTtcbiAgICB9KTtcbiAgfVxufVxuIl19